<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Osaka Go! 2025</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@500;700;900&display=swap"
        rel="stylesheet">
    <style>
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            transition: background 0.5s ease;
        }

        .card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border-radius: 1.5rem;
            transition: transform 0.2s;
            position: relative;
            z-index: 10;
        }

        .card:active {
            transform: scale(0.98);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Modal å‹•ç•« */
        .modal-enter-active,
        .modal-leave-active {
            transition: opacity 0.3s;
        }

        .modal-enter-from,
        .modal-leave-to {
            opacity: 0;
        }

        .modal-enter-active .modal-content,
        .modal-leave-active .modal-content {
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .modal-enter-from .modal-content,
        .modal-leave-to .modal-content {
            transform: scale(0.9) translateY(20px);
        }

        /* é ç±¤é¸ä¸­å‹•ç•« */
        .tab-active {
            background-color: #fff;
            color: #ec4899;
            box-shadow: 0 2px 10px rgba(236, 72, 153, 0.2);
            transform: scale(1.05);
        }
    </style>
</head>

<body :class="theme.bgGradient">

    <div id="app" class="max-w-md mx-auto min-h-screen pb-32 transition-colors duration-500 relative flex flex-col">

        <header
            class="bg-white/90 backdrop-blur-md sticky top-0 z-50 shadow-sm rounded-b-[2rem] border-b-4 transition-colors duration-500 flex-shrink-0"
            :class="theme.borderColor">
            <div class="p-4">
                <div class="flex justify-between items-center mb-3">
                    <div>
                        <h1 class="text-3xl font-black tracking-wide flex items-center gap-2" :class="theme.textColor">
                            Osaka Go!
                            <span class="text-2xl animate-bounce">{{ theme.icon }}</span>
                        </h1>
                        <div class="text-xs font-bold text-gray-400 mt-1 pl-1">12/20 - 12/27 âœ¨ {{ theme.slogan }}</div>
                    </div>

                    <div class="flex gap-3">
                        <button @click="showShoppingList = true"
                            class="w-10 h-10 rounded-full flex items-center justify-center text-xl shadow-sm border-2 border-gray-100 bg-white hover:bg-gray-50 transition active:scale-95 relative">
                            ğŸ“
                            <span v-if="shoppingList.filter(i=>!i.checked).length > 0"
                                class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white text-[10px] rounded-full flex items-center justify-center">
                                {{ shoppingList.filter(i=>!i.checked).length }}
                            </span>
                        </button>
                        <button @click="showTranslator = true"
                            class="w-10 h-10 rounded-full flex items-center justify-center text-xl shadow-sm border-2 border-gray-100 bg-white hover:bg-gray-50 transition active:scale-95">
                            ğŸ—£ï¸
                        </button>
                    </div>
                </div>

                <div class="flex justify-center gap-4 mt-2 bg-gray-50/50 p-2 rounded-2xl border border-gray-100">
                    <button @click="setTheme('chiikawa')"
                        class="w-10 h-10 rounded-full bg-pink-100 flex items-center justify-center text-xl relative transition-transform hover:scale-110"
                        :class="{'ring-2 ring-pink-300 ring-offset-2': currentThemeKey === 'chiikawa'}">ğŸ¹</button>
                    <button @click="setTheme('hachiware')"
                        class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-xl relative transition-transform hover:scale-110"
                        :class="{'ring-2 ring-blue-300 ring-offset-2': currentThemeKey === 'hachiware'}">ğŸ±</button>
                    <button @click="setTheme('usagi')"
                        class="w-10 h-10 rounded-full bg-yellow-100 flex items-center justify-center text-xl relative transition-transform hover:scale-110"
                        :class="{'ring-2 ring-yellow-300 ring-offset-2': currentThemeKey === 'usagi'}">ğŸ°</button>
                </div>
            </div>
        </header>

        <div
            class="mx-4 mt-3 mb-1 p-3 bg-white rounded-2xl shadow-sm border border-gray-100 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <span class="text-xs font-bold text-white px-2 py-1 rounded-lg" :class="theme.btnColor">Â¥ åŒ¯ç‡</span>
                <span class="text-sm font-bold text-gray-600">{{ currentRate }}</span>
            </div>
            <div class="flex items-center gap-2">
                <input type="number" v-model="jpyAmount" placeholder="JPY"
                    class="w-20 p-1 bg-gray-50 border rounded text-right text-sm">
                <span class="text-xs text-gray-400">â‰ˆ</span>
                <span class="font-bold text-gray-800">${{ twdAmount }}</span>
            </div>
        </div>

        <div class="sticky top-[165px] z-40 bg-white/95 backdrop-blur shadow-sm pt-2 pb-2 overflow-x-auto no-scrollbar flex gap-2 px-4 border-b border-gray-100"
            ref="tabContainer">
            <button v-for="(day, index) in itinerary" :key="index" @click="activeDayIndex = index"
                :id="'day-tab-' + index"
                class="flex-shrink-0 px-4 py-2 rounded-xl text-sm font-bold transition-all border border-transparent whitespace-nowrap"
                :class="activeDayIndex === index ? 'bg-gray-800 text-white shadow-lg scale-105' : 'bg-gray-100 text-gray-400 hover:bg-gray-200'">
                {{ day.date.split(' ')[0] }}
                <span class="block text-[10px] font-normal opacity-80">{{ day.area }}</span>
            </button>
        </div>

        <div class="p-4 flex-1 overflow-y-auto">

            <div class="mb-4 p-3 bg-blue-50 rounded-xl border border-blue-100 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <span class="text-lg">ğŸ¨</span>
                    <div class="text-xs text-blue-800">
                        <span class="font-bold block">ä»Šæ™šä½ï¼š{{ getHotelName(activeDayIndex) }}</span>
                        <a :href="getMapLink(getHotelName(activeDayIndex))" target="_blank"
                            class="underline opacity-70">å°èˆªå»é£¯åº—</a>
                    </div>
                </div>
            </div>

            <div v-if="activeDayIndex === 0" class="card mb-4 p-4 border-l-[6px] border-purple-400 bg-purple-50">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-purple-800">âœˆï¸ å»ç¨‹èˆªç­ (æ˜Ÿå®‡èˆªç©º)</h3>
                    <span class="text-xs bg-white px-2 py-1 rounded text-purple-600 font-bold">JX822</span>
                </div>
                <div class="flex justify-between text-sm text-gray-700 font-mono">
                    <div class="text-center">
                        <div class="font-bold text-xl">09:20</div>
                        <div class="text-xs text-gray-500">TPE æ¡ƒåœ’</div>
                    </div>
                    <div class="flex flex-col items-center justify-center px-2"><span class="text-xs text-gray-400">2h
                            30m</span>
                        <div class="w-16 h-0.5 bg-gray-300 relative"><span class="absolute -top-1.5 right-0">âœˆ</span>
                        </div>
                    </div>
                    <div class="text-center">
                        <div class="font-bold text-xl">12:50</div>
                        <div class="text-xs text-gray-500">KIX é—œè¥¿</div>
                    </div>
                </div>
            </div>

            <div v-if="activeDayIndex === 7" class="card mb-4 p-4 border-l-[6px] border-purple-400 bg-purple-50">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="font-bold text-purple-800">âœˆï¸ å›ç¨‹èˆªç­ (æ˜Ÿå®‡èˆªç©º)</h3>
                    <span class="text-xs bg-white px-2 py-1 rounded text-purple-600 font-bold">JX823</span>
                </div>
                <div class="flex justify-between text-sm text-gray-700 font-mono">
                    <div class="text-center">
                        <div class="font-bold text-xl">14:00</div>
                        <div class="text-xs text-gray-500">KIX é—œè¥¿</div>
                    </div>
                    <div class="flex flex-col items-center justify-center px-2"><span class="text-xs text-gray-400">3h
                            15m</span>
                        <div class="w-16 h-0.5 bg-gray-300 relative"><span class="absolute -top-1.5 right-0">âœˆ</span>
                        </div>
                    </div>
                    <div class="text-center">
                        <div class="font-bold text-xl">16:15</div>
                        <div class="text-xs text-gray-500">TPE æ¡ƒåœ’</div>
                    </div>
                </div>
            </div>

            <div class="space-y-4 pb-10">
                <div v-if="getMorningStart(activeDayIndex)" class="relative pl-8 flex items-center">
                    <div
                        class="absolute left-[29px] top-1/2 bottom-[-20px] w-0.5 border-l-2 border-dashed border-gray-300">
                    </div>
                    <a :href="getPointToPointLink(getMorningStart(activeDayIndex), itinerary[activeDayIndex].spots[0].name)"
                        target="_blank"
                        class="relative z-10 flex items-center gap-2 bg-white border border-gray-200 shadow-sm px-4 py-2 rounded-full text-xs font-bold text-gray-600 hover:text-blue-600 transition ml-6 w-full justify-center">
                        <span class="text-lg">ğŸŒ…</span>
                        <span>é£¯åº—å‡ºç™¼</span>
                        <span class="text-gray-300">âœ</span>
                        <span class="truncate max-w-[120px]">{{ itinerary[activeDayIndex].spots[0].name }}</span>
                    </a>
                </div>

                <div v-for="(item, i) in itinerary[activeDayIndex].spots" :key="i" class="relative">
                    <div class="card p-4 border-l-[6px]" :class="item.mustGo ? theme.borderColor : 'border-l-gray-300'"
                        @click.stop="openMap(item.name)">
                        <div class="flex gap-3">
                            <div class="flex flex-col items-center gap-1 min-w-[50px]">
                                <span class="text-xs font-bold text-gray-400 bg-gray-100 px-2 py-1 rounded">{{ item.time
                                    }}</span>
                                <div class="text-2xl mt-1">{{ getTypeIcon(item.type) }}</div>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-gray-800 leading-tight">{{ item.name }}</h3>
                                    <span v-if="item.mustGo"
                                        class="shrink-0 text-[10px] text-white px-2 py-0.5 rounded-full shadow-sm ml-2"
                                        :class="theme.btnColor">å¿…å»</span>
                                </div>
                                <p class="text-sm text-gray-500 mt-1 whitespace-pre-wrap">{{ item.desc }}</p>

                                <div v-if="item.ticket" class="mt-2">
                                    <a :href="item.ticket.url" target="_blank" @click.stop
                                        class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-bold w-full justify-center border"
                                        :class="item.ticket.booked ? 'bg-green-50 text-green-700 border-green-200' : 'bg-red-50 text-red-500 border-red-200'">
                                        <span v-if="item.ticket.booked">âœ… {{ item.ticket.source }}</span>
                                        <span v-else>ğŸ« å‰å¾€è³¼è²·</span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="i < itinerary[activeDayIndex].spots.length - 1"
                        class="relative pl-8 py-2 flex items-center">
                        <div class="absolute left-[29px] top-0 bottom-0 w-0.5 border-l-2 border-dashed border-gray-300">
                        </div>
                        <a :href="getPointToPointLink(item.name, itinerary[activeDayIndex].spots[i+1].name)"
                            target="_blank"
                            class="relative z-10 flex items-center gap-2 bg-white border border-gray-200 shadow-sm px-3 py-1.5 rounded-full text-xs font-bold text-gray-400 hover:text-blue-500 transition ml-6 w-full justify-center">
                            <span>ğŸš¶/ğŸš‡</span>
                            <span>å‰å¾€ä¸‹å€‹åœ°é»</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <transition name="modal">
            <div v-if="showShoppingList"
                class="fixed inset-0 z-[100] flex items-end sm:items-center justify-center px-4 py-6"
                style="background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);">
                <div class="absolute inset-0" @click="showShoppingList = false"></div>
                <div class="modal-content w-full max-w-sm bg-white rounded-3xl shadow-2xl overflow-hidden relative border-4 flex flex-col max-h-[80vh]"
                    :class="theme.borderColor">
                    <div class="p-4 border-b flex justify-between items-center" :class="theme.lightBg">
                        <h3 class="font-bold text-lg flex items-center gap-2" :class="theme.textColor">ğŸ“ å¿…è²·æ¸…å–®</h3>
                        <button @click="showShoppingList = false" class="text-2xl font-bold text-gray-400">Ã—</button>
                    </div>

                    <div class="p-3 bg-gray-50 border-b flex gap-2">
                        <input type="text" v-model="newItemText" placeholder="è¼¸å…¥å•†å“..."
                            class="flex-1 p-2 rounded-lg border text-sm" @keyup.enter="addShoppingItem">
                        <button @click="addShoppingItem" class="px-4 py-2 rounded-lg text-white font-bold text-sm"
                            :class="theme.btnColor">ï¼‹</button>
                    </div>

                    <div class="flex-1 overflow-y-auto p-4 space-y-3">
                        <div v-for="(item, idx) in shoppingList" :key="idx"
                            class="flex items-start gap-3 p-3 rounded-xl border transition-all"
                            :class="item.checked ? 'bg-gray-100 border-gray-200 opacity-60' : 'bg-white border-gray-200 shadow-sm'">
                            <input type="checkbox" v-model="item.checked"
                                class="mt-1 w-5 h-5 accent-pink-500 flex-shrink-0">

                            <div class="flex-1 min-w-0">
                                <div v-if="!item.isEditing">
                                    <div class="font-bold text-gray-800 break-words"
                                        :class="{'line-through': item.checked}">{{ item.text }}</div>
                                    <div class="text-xs text-gray-400 mt-0.5 break-words"
                                        v-if="item.note || item.text.includes('é›…è©©è˜­é»›')">{{ item.note }}</div>
                                </div>
                                <div v-else class="space-y-2">
                                    <input type="text" v-model="item.text"
                                        class="w-full text-sm font-bold border rounded p-1" placeholder="å•†å“åç¨±">
                                    <input type="text" v-model="item.note" class="w-full text-xs border rounded p-1"
                                        placeholder="å‚™è¨» (é¸å¡«)">
                                </div>

                                <div v-if="item.image" class="mt-2 relative group w-fit">
                                    <img :src="item.image" class="w-20 h-20 object-cover rounded-lg border">
                                    <button @click="removeImage(idx)"
                                        class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs shadow-md">Ã—</button>
                                </div>
                                <label v-else-if="!item.isEditing"
                                    class="mt-1 inline-flex items-center gap-1 text-xs text-blue-500 cursor-pointer">
                                    ğŸ“· æˆªåœ–/æ‹ç…§
                                    <input type="file" accept="image/*" class="hidden"
                                        @change="(e) => handleItemImage(e, idx)">
                                </label>
                            </div>

                            <div class="flex flex-col gap-1">
                                <button @click="item.isEditing = !item.isEditing"
                                    class="text-gray-400 hover:text-blue-500 p-1">
                                    {{ item.isEditing ? 'ğŸ’¾' : 'âœï¸' }}
                                </button>
                                <button @click="shoppingList.splice(idx, 1)"
                                    class="text-gray-300 hover:text-red-500 p-1">Ã—</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="modal">
            <div v-if="showTranslator"
                class="fixed inset-0 z-[100] flex items-end sm:items-center justify-center px-4 py-6"
                style="background: rgba(0,0,0,0.4); backdrop-filter: blur(4px);">
                <div class="absolute inset-0" @click="showTranslator = false"></div>
                <div class="modal-content w-full max-w-sm bg-white rounded-3xl shadow-2xl overflow-hidden relative border-4"
                    :class="theme.borderColor">
                    <div class="p-4 flex justify-between items-center border-b" :class="theme.lightBg">
                        <h3 class="font-bold text-lg flex items-center gap-2" :class="theme.textColor">ğŸ—£ï¸ æ—¥èªå°å¹«æ‰‹</h3>
                        <button @click="showTranslator = false"
                            class="text-gray-400 hover:text-gray-600 text-2xl font-bold">Ã—</button>
                    </div>
                    <div class="flex p-2 gap-2 overflow-x-auto no-scrollbar bg-gray-50">
                        <button v-for="cat in ['ç”¨é¤', 'äº¤é€š', 'è³¼ç‰©', 'é€šç”¨']" :key="cat" @click="currentCategory = cat"
                            class="flex-1 py-2 px-3 rounded-xl text-xs font-bold transition-all whitespace-nowrap"
                            :class="currentCategory === cat ? theme.btnColor + ' text-white shadow-md' : 'bg-white text-gray-500 border'">{{
                            cat }}</button>
                    </div>
                    <div class="h-[300px] overflow-y-auto p-4 space-y-3 bg-gray-50">
                        <div v-for="(phrase, idx) in currentPhrases" :key="idx"
                            class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 flex items-center justify-between active:scale-95 transition-transform"
                            @click="speakJapanese(phrase.jp)">
                            <div>
                                <div class="font-bold text-gray-800">{{ phrase.tw }}</div>
                                <div class="text-xs text-gray-400 font-mono mt-1">{{ phrase.romaji }}</div>
                                <div class="text-sm text-gray-600 mt-0.5">{{ phrase.jp }}</div>
                            </div>
                            <button
                                class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-xl shadow-sm group-hover:bg-blue-100">ğŸ”Š</button>
                        </div>
                    </div>
                </div>
            </div>
        </transition>

    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch } = Vue;

        const AID = '27749';
        const appendAID = (url) => url.includes('aid=') ? url : `${url}${url.includes('?') ? '&' : '?'}aid=${AID}`;

        // Add storage key
        const STORAGE_KEY = 'osaka_go_shopping_list';

        const THEMES = {
            chiikawa: { name: 'å‰ä¼Š', icon: 'ğŸ¹', slogan: 'WakuWaku', bgGradient: 'bg-gradient-to-br from-pink-50 via-white to-pink-100', textColor: 'text-pink-500', borderColor: 'border-pink-300', btnColor: 'bg-pink-400', lightBg: 'bg-pink-50', lightBorder: 'border-pink-100' },
            hachiware: { name: 'å°å…«', icon: 'ğŸ±', slogan: 'Nantoka-nare', bgGradient: 'bg-gradient-to-br from-blue-50 via-white to-blue-100', textColor: 'text-blue-500', borderColor: 'border-blue-300', btnColor: 'bg-blue-400', lightBg: 'bg-blue-50', lightBorder: 'border-blue-100' },
            usagi: { name: 'çƒè–©å¥‡', icon: 'ğŸ°', slogan: 'Ura!', bgGradient: 'bg-gradient-to-br from-yellow-50 via-white to-orange-100', textColor: 'text-yellow-600', borderColor: 'border-yellow-400', btnColor: 'bg-yellow-400', lightBg: 'bg-yellow-50', lightBorder: 'border-yellow-200' }
        };

        const JP_DATA = {
            'ç”¨é¤': [
                { tw: 'æˆ‘è¨‚ä½äº† (Hsu)', jp: 'äºˆç´„ã—ãŸå¾ (ã‚·ãƒ¥ãƒ¼) ã§ã™', romaji: 'Yoyaku shita Hsu desu' },
                { tw: 'æˆ‘è¦é€™å€‹', jp: 'ã“ã‚Œã‚’ãã ã•ã„', romaji: 'Kore o kudasai' },
                { tw: 'çµå¸³', jp: 'ãŠä¼šè¨ˆã‚’ãŠé¡˜ã„ã—ã¾ã™', romaji: 'Okaikei onegaishimasu' },
                { tw: 'æœ‰ç¦è¸å¸­å—ï¼Ÿ', jp: 'ç¦ç…™å¸­ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ', romaji: 'Kinen seki wa arimasu ka?' }
            ],
            'äº¤é€š': [{ tw: 'è»Šç«™å“ªè£¡ï¼Ÿ', jp: 'é§…ã¯ã©ã“ã§ã™ã‹ï¼Ÿ', romaji: 'Eki wa doko?' }, { tw: 'æˆ‘æƒ³å»é€™è£¡', jp: 'ã“ã“ã«è¡ŒããŸã„ã§ã™', romaji: 'Koko ni ikitai' }, { tw: 'èƒ½ç”¨ICå¡å—ï¼Ÿ', jp: 'ICã‚«ãƒ¼ãƒ‰ã¯ä½¿ãˆã¾ã™ã‹ï¼Ÿ', romaji: 'IC kado wa tsukaemasu ka?' }],
            'è³¼ç‰©': [{ tw: 'å¤šå°‘éŒ¢ï¼Ÿ', jp: 'ã„ãã‚‰ã§ã™ã‹ï¼Ÿ', romaji: 'Ikura desu ka?' }, { tw: 'å¯ä»¥å…ç¨…å—ï¼Ÿ', jp: 'å…ç¨ã§ãã¾ã™ã‹ï¼Ÿ', romaji: 'Menzei dekimasu ka?' }, { tw: 'è«‹çµ¦æˆ‘è¢‹å­', jp: 'è¢‹ã‚’ãã ã•ã„', romaji: 'Fukuro o kudasai' }],
            'é€šç”¨': [{ tw: 'è¬è¬', jp: 'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™', romaji: 'Arigatou' }, { tw: 'ä¸å¥½æ„æ€', jp: 'ã™ã¿ã¾ã›ã‚“', romaji: 'Sumimasen' }, { tw: 'å»æ‰€ï¼Ÿ', jp: 'ãƒˆã‚¤ãƒ¬ã¯ã©ã“ã§ã™ã‹ï¼Ÿ', romaji: 'Toire wa doko?' }]
        };

        createApp({
            setup() {
                const currentThemeKey = ref('hachiware');
                const activeDayIndex = ref(0); // é è¨­ç¬¬ä¸€å¤©
                const jpyAmount = ref('');
                const rate = ref(0.22);
                const currentRate = ref('0.2200');
                const showTranslator = ref(false);
                const currentCategory = ref('ç”¨é¤');

                // ğŸŒŸ è³¼ç‰©æ¸…å–® (å·²åŠ å…¥åª½åª½çš„éœ€æ±‚) ğŸŒŸ
                const showShoppingList = ref(false);
                const newItemText = ref('');

                // Load from localStorage or use default
                const defaultList = [
                    { text: 'é›…è©©è˜­é»› å¹´è¼•ç„¡æ•µè† åŸéœœ (75ml)', checked: false, note: 'çµ¦åª½åª½ (Mom)', image: './assets/estee_cream.png' },
                    { text: 'é›…è©©è˜­é»› ç‰¹æ½¤è¶…å°å…¨æ–¹ä½ä¿®è­·éœ² (50ml)', checked: false, note: 'çµ¦åª½åª½ (å°æ£•ç“¶)', image: './assets/estee_serum.png' },
                    { text: 'EVE æ­¢ç—›è—¥ (è—è‰²)', checked: false, note: '' },
                    { text: 'åˆåˆ©ä»–å‘½ EX', checked: false, note: '' }
                ];
                const shoppingList = ref(JSON.parse(localStorage.getItem(STORAGE_KEY)) || defaultList);

                // Watch for changes and save
                watch(shoppingList, (newVal) => {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(newVal));
                }, { deep: true });

                const theme = computed(() => THEMES[currentThemeKey.value]);
                const setTheme = (key) => currentThemeKey.value = key;
                const currentPhrases = computed(() => JP_DATA[currentCategory.value]);
                const twdAmount = computed(() => !jpyAmount.value ? 0 : Math.ceil(jpyAmount.value * rate.value));

                // Auto-inject images for existing items if missing (One-time fix for user)
                onMounted(() => {
                    shoppingList.value.forEach(item => {
                        if (item.text.includes('å¹´è¼•ç„¡æ•µè† åŸéœœ') && !item.image) item.image = './assets/estee_cream.png';
                        if (item.text.includes('ç‰¹æ½¤è¶…å°å…¨æ–¹ä½ä¿®è­·éœ²') && !item.image) item.image = './assets/estee_serum.png';
                    });

                    // åŒ¯ç‡ API (åŸæœ‰é‚è¼¯)
                    fetch('https://api.allorigins.win/get?url=' + encodeURIComponent('https://tw.rter.info/capi.php'))
                        .then(res => res.json())
                        .then(raw => {
                            const data = JSON.parse(raw.contents);
                            if (data.USDTWD && data.USDJPY) {
                                currentRate.value = (data.USDTWD.Exrate / data.USDJPY.Exrate).toFixed(4);
                            }
                        });

                    // è‡ªå‹•è·³åˆ°ç•¶å¤© (åŸæœ‰é‚è¼¯)
                    const now = new Date();
                    const day = now.getDate();
                    if (now.getMonth() === 11 && day >= 20 && day <= 27) {
                        activeDayIndex.value = day - 20;
                        setTimeout(() => {
                            const tab = document.getElementById('day-tab-' + (day - 20));
                            if (tab) tab.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });
                        }, 500);
                    }
                });

                // Klook Links
                const LINKS = {
                    HARUKA: appendAID('https://www.klook.com/zh-TW/activity/18400-jr-haruka-airport-express-train-tickets-osaka/'),
                    AMANOHASHIDATE: appendAID('https://www.klook.com/zh-TW/activity/25686-amanohashidate-ine-boathouse-miyama-kayabuki-no-sato-day-tour-osaka/'),
                    UMEDA_SKY: appendAID('https://www.klook.com/zh-TW/activity/1301-umeda-sky-building-osaka/'),
                    RAPIT: appendAID('https://www.klook.com/zh-TW/activity/599-kansai-airport-nankai-line-osaka/'),
                    HARUKAS: appendAID('https://www.klook.com/zh-TW/activity/2424-harukas-300-observatory-ticket-osaka/'),
                    ESIM: appendAID('https://www.klook.com/zh-TW/activity/109393-japan-esim-high-speed-internet-qr-code-voucher/')
                };

                const addShoppingItem = () => {
                    if (newItemText.value.trim()) {
                        shoppingList.value.push({ text: newItemText.value, checked: false, image: null, note: '' });
                        newItemText.value = '';
                    }
                };

                const handleItemImage = (e, idx) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => shoppingList.value[idx].image = e.target.result;
                        reader.readAsDataURL(file);
                    }
                };
                const removeImage = (idx) => shoppingList.value[idx].image = null;

                const speakJapanese = (text) => {
                    if ('speechSynthesis' in window) {
                        const u = new SpeechSynthesisUtterance(text);
                        u.lang = 'ja-JP'; u.rate = 0.9;
                        window.speechSynthesis.cancel(); window.speechSynthesis.speak(u);
                    }
                };

                const getPointToPointLink = (origin, dest) => `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(dest)}&travelmode=transit&dirflg=r`;
                const getMapLink = (q) => `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(q)}`;
                const openMap = (q) => window.open(getMapLink(q), '_blank');

                const getMorningStart = (dayIndex) => {
                    if (dayIndex === 0) return null;
                    if (dayIndex <= 4) return 'VIA INN PRIME KYOTOEKI HACHIJOGUCHI';
                    return 'Sotetsu Fresa Inn Osaka-Namba';
                };
                const getHotelName = (dayIndex) => dayIndex <= 4 ? 'äº¬éƒ½ VIA INN PRIME å…«æ¢å£' : 'å¤§é˜ª ç›¸éµ Fresa Inn é›£æ³¢';

                const getTypeIcon = (t) => ({ food: 'ğŸœ', shop: 'ğŸ›ï¸', spot: 'â›©ï¸', cafe: 'â˜•', transport: 'ğŸš', net: 'ğŸ“¶' }[t] || 'ğŸ“');

                // ğŸŒŸ è¡Œç¨‹è³‡æ–™ (å«æ¥é€èˆ‡è¨‚ä½) ğŸŒŸ
                const itinerary = ref([
                    {
                        date: '12/20 (å…­)', area: 'äº¬éƒ½è»Šç«™',
                        spots: [
                            { time: '06:15', type: 'transport', name: 'æ©Ÿå ´æ¥é€ (å‡ºç™¼)', desc: 'åªé ‚è·¯52å··16è™Ÿ ä¸Šè»Š -> æ¡ƒåœ’æ©Ÿå ´T1 ($1000/å·²åŒ¯)', mustGo: true },
                            { time: '12:00', type: 'net', name: 'å•Ÿç”¨ eSIM ç¶²è·¯', desc: 'æ¯æ—¥ 2GB / 8å¤© (æŠµé”å³ç”¨/é»æ“Šé–‹å•Ÿæ†‘è­‰)', ticket: { source: 'Klook æ†‘è­‰', url: LINKS.ESIM, booked: true } },
                            { time: '12:50', type: 'transport', name: 'é—œè¥¿æ©Ÿå ´ âœ äº¬éƒ½è»Šç«™ (Haruka)', desc: 'å…¥å¢ƒå¾Œé¦¬ä¸Šå‡ºç™¼ï¼(é»æ“Šé–‹å•Ÿæ†‘è­‰)', ticket: { source: 'Klook æ†‘è­‰', url: LINKS.HARUKA, booked: true } },
                            { time: '15:00', type: 'spot', name: 'VIA INN PRIME äº¬éƒ½å…«æ¢å£', desc: 'Check-in æ”¾è¡Œæ' },
                            { time: '17:00', type: 'food', mustGo: true, name: 'Sushi no Musashi', desc: 'è¿´è½‰å£½å¸ (è»Šç«™å…§)' },
                            { time: '19:00', type: 'shop', name: 'Kyoto Station', desc: 'å¤§éšæ¢¯ / è–èª•æ¨¹' }
                        ]
                    },
                    {
                        date: '12/21 (æ—¥)', area: 'åµå±±/é‡‘é–£å¯º',
                        spots: [
                            { time: '09:00', type: 'spot', mustGo: true, name: 'Arashiyama Bamboo Forest', desc: 'åµå±±ç«¹æ— (æ—©èµ·!)' },
                            { time: '11:00', type: 'food', name: 'Arashiyama Main Street', desc: 'åˆé¤ï¼šå»£å·é°»é­šæˆ–å°åƒ' },
                            { time: '13:30', type: 'spot', mustGo: true, name: 'Kinkaku-ji', desc: 'é‡‘é–£å¯º (æ­è¨ˆç¨‹è»Š/å·´å£«)' },
                            { time: '16:00', type: 'spot', name: 'Kyoto Station', desc: 'å›å¸‚å€' }
                        ]
                    },
                    {
                        date: '12/22 (ä¸€)', area: 'æµ·ä¹‹äº¬éƒ½',
                        spots: [
                            { time: '07:40', type: 'spot', mustGo: true, name: 'Kyoto Station Hachijo Exit', desc: 'ä¸€æ—¥éŠé›†åˆ (ç¢ºèªä¿¡ç®±)', ticket: { source: 'Klook', url: LINKS.AMANOHASHIDATE, booked: false } },
                            { time: '10:30', type: 'spot', name: 'Amanohashidate', desc: 'å¤©æ©‹ç«‹é£›é¾' },
                            { time: '13:00', type: 'spot', name: 'Ine no Funaya', desc: 'ä¼Šæ ¹èˆŸå±‹é¤µæµ·é·—' },
                            { time: '19:00', type: 'food', name: 'Kyoto Ramen Koji', desc: 'æ‹‰éºµå°è·¯' }
                        ]
                    },
                    {
                        date: '12/23 (äºŒ)', area: 'æ´›æ±ç²¾è¯',
                        spots: [
                            { time: '09:00', type: 'spot', name: 'Fushimi Inari Taisha', desc: 'åƒæœ¬é³¥å±…' },
                            { time: '10:00', type: 'shop', mustGo: true, name: 'Chiikawa Mogumogu Honpo', desc: 'å‰ä¼Šå¡å“‡ä¼è¦‹åº—' },
                            { time: '11:00', type: 'food', mustGo: true, name: 'Kyoto Ito Okashi', desc: 'ä¼Šè—¤è»’ç”œé»' },
                            { time: '12:00', type: 'food', mustGo: true, name: 'Nishiki Market', desc: 'éŒ¦å¸‚å ´åƒåˆé¤' },
                            { time: '14:00', type: 'spot', mustGo: true, name: 'Kiyomizu-dera', desc: 'æ¸…æ°´å¯º' },
                            { time: '15:30', type: 'shop', name: '2/8b pair keyholder', desc: 'å¯æ„›åŠé£¾' },
                            { time: '16:30', type: 'cafe', name: 'Blue Bottle Kyoto Kiyamachi', desc: 'è—ç“¶å’–å•¡' }
                        ]
                    },
                    {
                        date: '12/24 (ä¸‰)', area: 'å¤§é˜ªç§»å‹•æ—¥',
                        spots: [
                            { time: '10:00', type: 'spot', name: 'Sotetsu Fresa Inn Osaka-Namba', desc: 'ç§»å‹•è‡³å¤§é˜ª Check-in' },
                            { time: '11:00', type: 'spot', mustGo: true, name: 'Osaka Castle', desc: 'å¤§é˜ªåŸ' },
                            { time: '13:30', type: 'food', mustGo: true, name: 'Ichiran Namba', desc: 'ä¸€è˜­æ‹‰éºµ' },
                            { time: '15:00', type: 'shop', mustGo: true, name: 'Chiikawa Land Shinsaibashi', desc: 'PARCO å‰ä¼Šå¡å“‡' },
                            { time: '19:00', type: 'food', mustGo: true, name: 'Shabucho', desc: 'å’Œç‰›æ¶®æ¶®é‹' }
                        ]
                    },
                    {
                        date: '12/25 (å››)', area: 'æ¢…ç”°/è–èª•',
                        spots: [
                            { time: '10:00', type: 'shop', mustGo: true, name: 'Standard Products Umeda', desc: 'æ¢…ç”°DTå¡”B2 (é‚„æœ‰DAISO)' },
                            { time: '11:30', type: 'shop', mustGo: true, name: '3COINS +plus LUCUA', desc: '300åœ“é›œè²¨' },
                            { time: '12:30', type: 'food', name: 'Gyuta Honjin LINKS UMEDA', desc: 'åˆé¤ï¼šéš¨æ„åƒ (ä¸ç”¨å¤ªé£½)' },
                            { time: '14:00', type: 'shop', mustGo: true, name: 'Kiddyland Osaka Umeda', desc: 'å‰ä¼Šå¡å“‡å‘¨é‚Š' },
                            { time: '15:40', type: 'spot', name: 'Umeda Station', desc: 'âš ï¸ æº–å‚™æ­åœ°éµå¾¡å ‚ç­‹ç·šå›é›£æ³¢' },
                            { time: '16:50', type: 'food', mustGo: true, name: 'Yakiniku Rikimaru Dotonbori', desc: 'ã€å·²é ç´„ 16:50 âœ…ã€‘ç‡’è‚‰åŠ›ä¸¸ é“é “å €åº—', ticket: { source: 'è¨‚ä½ä¿¡', url: '#', booked: true } },
                            { time: '19:30', type: 'spot', name: 'Dotonbori Glico Man', desc: 'åƒé£½æ•£æ­¥çœ‹è·‘è·‘äºº' },
                            { time: '21:00', type: 'food', name: 'Mugi to Tori', desc: 'å®µå¤œï¼šé›ç™½æ¹¯æ‹‰éºµ' }
                        ]
                    },
                    {
                        date: '12/26 (äº”)', area: 'é›£æ³¢/é˜¿å€é‡',
                        spots: [
                            { time: '10:00', type: 'food', mustGo: true, name: 'CANELE du JAPON', desc: 'å¯éº—éœ²' },
                            { time: '12:30', type: 'food', mustGo: true, name: 'Unagi no Nakasho', desc: 'é°»é­šé£¯' },
                            { time: '14:30', type: 'shop', name: 'Namba Parks', desc: 'é€›è¡—è£œè²¨' },
                            { time: '16:00', type: 'spot', mustGo: true, name: 'Tsutenkaku', desc: 'é€šå¤©é–£ (æ–°ä¸–ç•Œ)' },
                            { time: '17:00', type: 'spot', mustGo: true, name: 'Harukas 300', desc: 'é˜¿å€é‡å±•æœ›å°å¤œæ™¯', ticket: { source: 'Klook', url: LINKS.HARUKAS, booked: false } },
                            { time: '19:00', type: 'food', name: 'Kushikatsu Daruma', desc: 'æ™šé¤ï¼šæ–°ä¸–ç•Œç‚¸ä¸² (å…ƒç¥–ä¸²ç‚¸)' },
                            { time: '21:00', type: 'shop', mustGo: true, name: 'Don Quijote Dotonbori', desc: 'å”å‰è¨¶å¾·ï¼š24Hè²·çˆ† (å›é£¯åº—è·¯ä¸Š)' }
                        ]
                    },
                    {
                        date: '12/27 (å…­)', area: 'è¿”ç¨‹',
                        spots: [
                            { time: '09:30', type: 'spot', name: 'Namba Station', desc: 'æ­ä¹˜ Rapi:t æ©Ÿå ´ç‰¹æ€¥', ticket: { source: 'Klook', url: LINKS.RAPIT, booked: false } },
                            { time: '10:30', type: 'shop', name: 'Rinku Premium Outlets', desc: 'è‡¨ç©ºåŸ Outlet' },
                            { time: '14:00', type: 'spot', name: 'Kansai Airport', desc: 'JX823 èµ·é£› (14:00)' },
                            { time: '16:15', type: 'transport', mustGo: true, name: 'æ©Ÿå ´æ¥é€ (å›ç¨‹)', desc: 'æ¡ƒæ©ŸT1æ¥æ©Ÿ -> åªé ‚è·¯52å··16è™Ÿ ($1000/æœªåŒ¯æ¬¾!)' }
                        ]
                    }
                ]);



                return {
                    jpyAmount, twdAmount, currentRate, activeDayIndex,
                    showTranslator, showShoppingList, shoppingList, newItemText, addShoppingItem, handleItemImage, removeImage,
                    theme, setTheme, currentThemeKey,
                    currentCategory, currentPhrases, speakJapanese,
                    itinerary, getMorningStart, getHotelName, getTypeIcon, getPointToPointLink, openMap, getMapLink
                };
            }
        }).mount('#app');
    </script>

</body>

</html>